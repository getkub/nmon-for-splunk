<form stylesheet="ui_simple.css,panel_decoration.css">
    <label>UI RT LPAR, LPAR, Pool Virtual CPU Usage (AIX)</label>
    <description>Simplified Real Time capable User Interface for the LPAR monitor and IBM PSeries Pools usage statistics</description>

    <fieldset autoRun="false" submitButton="false">

        <input type="time" token="timerange" searchWhenChanged="true">
            <label>Time Range:</label>
            <default>
                <earliestTime>rt-4h</earliestTime>
                <latestTime>rtnow</latestTime>
            </default>

        </input>
        <input type="dropdown" token="timefilter" searchWhenChanged="true">
            <label>Time Filtering:</label>
            <choice value="No_Filter">No Filter (24/24, 7/7)</choice>
            <choice value="Day_BusinessDays_8h-19h">Day Business (08h-19h)</choice>
            <choice value="Day_WeekEnd_8h-19h">Day WE (08h-19h)</choice>
            <choice value="Day_AllDays_8h-19h">Day Week (08h-19h)</choice>
            <choice value="Night_BusinessDays_19h-8h">Night Business (19h-08h)</choice>
            <choice value="Night_WeekEnd_19h-8h">Night WE (19h-08h)</choice>
            <choice value="Night_AllDays_19h-8h">Night All Days (19h-08h)</choice>
            <default>No_Filter</default>
        </input>

        <input type="radio" token="appfilter" searchWhenChanged="true">
            <label>Filter Invalid APP:</label>
            <default>PoolIdle != 0</default>
            <choice value="PoolIdle != 0">True</choice>
            <choice value="PoolIdle >= 0">False</choice>
        </input>

        <input type="dropdown" token="Pool_id" searchWhenChanged="true">
            <label>Pool IDs: (0 for DefaultPool)</label>
            <!-- Populating Data Model Search -->
            <search base="populate">
                <query>stats count by Pool_id | sort Pool_id | dedup Pool_id</query>
            </search>
            <prefix>"</prefix>
            <suffix>"</suffix>
            <choice value="*">Any</choice>
            <default>*</default>
            <fieldForLabel>Pool_id</fieldForLabel>
            <fieldForValue>Pool_id</fieldForValue>
        </input>

        <input type="multiselect" token="frameID" searchWhenChanged="true">
            <label>Frame IDs:</label>
            <!-- Populating Data Model Search -->
            <search base="populate">
                <query>search Pool_id=$Pool_id$ | stats count by frameID | sort frameID | dedup frameID</query>
            </search>
            <prefix>"</prefix>
            <suffix>"</suffix>
            <choice value="*">Any</choice>
            <default>*</default>
            <fieldForLabel>frameID</fieldForLabel>
            <fieldForValue>frameID</fieldForValue>
        </input>

        <input type="text" token="hostname-prefilter" searchWhenChanged="true">
            <label>Optional: Filter hosts populating</label>
            <default>*</default>
        </input>

        <input type="multiselect" token="hostname" searchWhenChanged="true">
            <label>Hosts Selection:</label>
            <!-- Populating Data Model Search -->
            <search base="populate">
                <query>search Pool_id=$Pool_id$ frameID=$frameID$ hostname="$hostname-prefilter$" | stats count by hostname | sort hostname | dedup hostname</query>
            </search>
            <prefix>"</prefix>
            <suffix>"</suffix>
            <choice value="*">ALL Hosts</choice>
            <fieldForLabel>hostname</fieldForLabel>
            <fieldForValue>hostname</fieldForValue>
        </input>

        <input type="dropdown" token="monitor" searchWhenChanged="true">
            <label>Show CPU load by:</label>
            <default>Pool_usage</default>
            <choice value="Pool_usage">VP Usage</choice>
            <choice value="Pool_PCT_usage">VP Usage (% usage of capacity)</choice>
        </input>

        <input type="dropdown" token="statsmode" searchWhenChanged="true">
            <label>Stats mode:</label>
            <default>max</default>
            <choice value="max">Max</choice>
            <choice value="avg">Avg</choice>
            <choice value="min">Min</choice>
            <choice value="median">Median</choice>
            <choice value="mode">Mode</choice>
            <choice value="range">Range</choice>
        </input>

    </fieldset>

    <!-- Base Searches for PostProcessing -->

    <search id="populate">
        <query>| pivot NMON_Data_CPU LPAR_Pool count(LPAR_Pool) AS "count" SPLITROW frameID AS frameID SPLITROW hostname AS hostname SPLITROW Pool_id AS Pool_id FILTER $appfilter$ SORT 0 frameID ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 0 SHOWOTHER 1</query>
        <earliest>$timerange.earliest$</earliest>
        <latest>$timerange.latest$</latest>
    </search>

    <search id="Global">
        <query>| pivot NMON_Data_CPU LPAR_Pool max(poolCPUs) AS "CPUs in Pool" max($monitor$) AS "max_usage" avg($monitor$) AS "avg_usage" min($monitor$) AS "min_usage"
SPLITROW hostname AS hostname SPLITROW frameID AS frameID SPLITROW Pool_id AS Pool_id FILTER $appfilter$ FILTER Pool_id is $Pool_id$ FILTER frameID is $frameID$ FILTER hostname is $hostname-prefilter$ FILTER hostname is $hostname$ SORT 0 hostname ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 0 SHOWOTHER 1</query>
        <earliest>$timerange.earliest$</earliest>
        <latest>$timerange.latest$</latest>
    </search>

    <!-- Help the user -->

    <row rejects="$hostname$">
        <panel>
            <html>
                <p style="color:red;text-align:center;font-size:14px"> - - - - - - - - - - ACTION REQUIRED: please select your server name in the host selector above - - - - - - - - - -</p>
            </html>
        </panel>
    </row>

    <row>
        <panel>

            <single>
                <search base="Global">
                    <query>stats max(max_usage) AS max</query>
                </search>
                <option name="underLabel">Maximum Load</option>
                <option name="numberPrecision">0.00</option>
            </single>

            <single>
                <search base="Global">
                    <query>stats avg(avg_usage) AS avg | eval avg=round(avg,2)</query>
                </search>
                <option name="underLabel">Average Load</option>
                <option name="numberPrecision">0.00</option>
            </single>

            <single>
                <search base="Global">
                    <query>stats min(min_usage) AS min</query>
                </search>
                <option name="underLabel">Minimal Load</option>
                <option name="numberPrecision">0.00</option>
            </single>

            <table>
                <search base="Global">
                    <query>foreach max_usage,avg_usage,min_usage [ eval "&lt;&lt;FIELD&gt;&gt;"=round('&lt;&lt;FIELD&gt;&gt;', 2) ] | fields hostname,frameID,Pool_id,"CPUs in Pool",max_usage,avg_usage,min_usage</query>
                </search>
                <option name="wrap">true</option>
                <option name="rowNumbers">false</option>
                <option name="dataOverlayMode">none</option>
                <option name="drilldown">row</option>
                <option name="count">10</option>
                <drilldown target="search">
                    <link>
                        <![CDATA[
/app/nmon/search?earliest=$timerange.earliest$&latest=$timerange.latest$&q=| pivot NMON_Data_CPU LPAR_Pool max(poolCPUs) AS "CPUs in Pool" max($monitor$) AS "max_usage" avg($monitor$) AS "avg_usage" min($monitor$) AS "min_usage" 
SPLITROW hostname AS hostname SPLITROW frameID AS frameID SPLITROW Pool_id AS Pool_id FILTER $appfilter$ FILTER Pool_id is $Pool_id$ FILTER frameID is $frameID$ FILTER hostname is $hostname-prefilter$ FILTER hostname is $click.value$ SORT 0 hostname ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 0 SHOWOTHER 0
			]]></link>
                </drilldown>
            </table>

        </panel>
    </row>

    <row>
        <panel id="settings">
            <title>Charting parameters</title>
            <input type="dropdown" token="period" searchWhenChanged="true">
                <label>Period:</label>
                <default>minute</default>
                <choice value="auto">Auto</choice>
                <choice value="second">Secondes</choice>
                <choice value="minute">Minutes</choice>
                <choice value="hour">Hours</choice>
                <choice value="day">Days</choice>
                <choice value="month">Months</choice>
                <choice value="year">Years</choice>
            </input>
            <input type="dropdown" token="addindicator" searchWhenChanged="true">
                <label>Pool additional Series:</label>
                <default>none</default>
                <choice value="">none</choice>
                <choice value="max(poolCPUs) AS poolCPUs">poolCPUs: Nbr of CPUs in Pool</choice>
            </input>
            <input type="dropdown" token="chart" searchWhenChanged="true">
                <label>Select a type of chart:</label>
                <default>line</default>
                <choice value="area">Area</choice>
                <choice value="line">Line</choice>
                <choice value="column">Column</choice>
                <choice value="bar">Bar</choice>
            </input>
            <input type="dropdown" token="charting.chart.nullValueMode" searchWhenChanged="true">
                <label>Missing Data:</label>
                <default>gaps</default>
                <choice value="gaps">Gaps</choice>
                <choice value="connect">Connect</choice>
                <choice value="zero">Zero</choice>
            </input>
            <input type="dropdown" token="chart.stackingmode" searchWhenChanged="true">
                <label>Select a stacking mode:</label>
                <default>unstacked</default>
                <choice value="stacked">stacked (lines excluded)</choice>
                <choice value="stacked100">100% stacked (lines excluded)</choice>
                <choice value="unstacked">unstacked</choice>
            </input>
            <input type="dropdown" token="charting.legend.placement" searchWhenChanged="true">
                <label>Legend placement:</label>
                <default>bottom</default>
                <choice value="bottom">Bottom</choice>
                <choice value="top">Top</choice>
                <choice value="left">left</choice>
                <choice value="right">right</choice>
                <choice value="center">center</choice>
                <choice value="none">none</choice>
            </input>
        </panel>
    </row>

    <row>
        <panel id="cpu">
            <title>Shared Pool CPU statistics</title>
            <chart>
                <search id="timechart">
                    <query>| pivot NMON_Data_CPU LPAR_Pool $statsmode$($monitor$) AS $monitor$ $addindicator$
SPLITROW _time AS _time PERIOD $period$ SPLITCOL hostname FILTER $appfilter$ FILTER Pool_id is $Pool_id$ FILTER frameID is $frameID$ FILTER hostname is $hostname-prefilter$ FILTER hostname is $hostname$ SORT 0 _time ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 0 SHOWOTHER 0</query>
                    <earliest>$timerange.earliest$</earliest>
                    <latest>$timerange.latest$</latest>
                </search>
                <option name="charting.axisTitleX.visibility">visible</option>
                <option name="charting.axisTitleY.visibility">visible</option>
                <option name="charting.axisX.scale">linear</option>
                <option name="charting.axisY.scale">linear</option>
                <option name="charting.chart">$chart$</option>
                <option name="charting.chart.nullValueMode">$charting.chart.nullValueMode$</option>
                <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
                <option name="charting.chart.stackMode">$chart.stackingmode$</option>
                <option name="charting.chart.style">shiny</option>
                <option name="charting.drilldown">all</option>
                <option name="charting.layout.splitSeries">0</option>
                <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
                <option name="charting.legend.placement">$charting.legend.placement$</option>
                <option name="height">680</option>
                <option name="charting.axisTitleX.text">Time</option>
                <option name="charting.axisTitleY.text">Virtual CPUs</option>
                <option name="charting.axisY.minimumNumber">0</option>
                <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
                <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
                <option name="charting.axisTitleY2.visibility">visible</option>
                <option name="charting.axisY2.enabled">false</option>
                <option name="charting.axisY2.scale">inherit</option>
                <drilldown target="search">
                    <link>
                        <![CDATA[
/app/nmon/search?earliest=$earliest$&latest=$latest$&q=| pivot NMON_Data_CPU LPAR_Pool $statsmode$($monitor$) AS $monitor$ $addindicator$ 
SPLITROW _time AS _time PERIOD $period$ SPLITCOL hostname FILTER $appfilter$ FILTER Pool_id is $Pool_id$ FILTER frameID is $frameID$ FILTER hostname is $hostname-prefilter$ FILTER hostname is $hostname$ SORT 0 _time ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 0 SHOWOTHER 0
			]]></link>
                </drilldown>
            </chart>
        </panel>
    </row>

</form>